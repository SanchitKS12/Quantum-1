from django.views import View
from django.shortcuts import render
from .forms import ScanForm
from .utils import FeatureExtractor
from .predict import DetectionService
from .models import ScanRecord

PDF_PATH = '/mnt/data/Quantum Machine Learning for Threat Detection.pdf'

class HomeView(View):
    def get(self, request):
        ctx = {
            'site_title': 'Quantum Malware Hunter',
            'tagline': 'AI + Quantum cybersecurity for next-gen threat defense',
        }
        return render(request, 'detector/home.html', ctx)

class ScanView(View):
    extractor = FeatureExtractor()

    def get(self, request):
        form = ScanForm()
        return render(request, 'detector/scan.html', {'form': form})

    def post(self, request):
        form = ScanForm(request.POST, request.FILES)
        result = None
        if form.is_valid():
            raw = form.cleaned_data.get('network_data') or ''
            logfile = request.FILES.get('logfile')
            if logfile and not raw:
                raw = logfile.read().decode(errors='ignore')
            url = form.cleaned_data.get('url')
            if url and not raw:
                raw = f'URL provided: {url} (server-side fetching disabled)'
            features = self.extractor.extract(raw)
            detection = DetectionService.run_detection_from_features(features)
            try:
                ScanRecord.objects.create(
                    input_summary=(raw[:500] + '...') if len(raw) > 500 else raw,
                    label=detection['label'],
                    score=detection['score'],
                )
            except Exception:
                pass
            result = detection
        return render(request, 'detector/scan.html', {'form': form, 'result': result})

class AboutView(View):
    def get(self, request):
        return render(request, 'detector/about.html', {'pdf_path': PDF_PATH})
