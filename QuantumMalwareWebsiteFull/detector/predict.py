# detector/predict.py

from __future__ import annotations

from typing import Any, Dict

import numpy as np

from .quantum_detector import QuantumMalwareDetector


class DetectionService:
    """
    Singleton-style service to reuse the same model instance.
    """

    _detector: QuantumMalwareDetector | None = None

    @classmethod
    def get_detector(cls) -> QuantumMalwareDetector:
        if cls._detector is None:
            cls._detector = QuantumMalwareDetector()
        return cls._detector

    @classmethod
    def run_detection_from_features(cls, features: Any) -> Dict[str, Any]:
        """
        Called by the ScanView.

        `features` is expected to be a 1D numeric vector from FeatureExtractor.
        """
        detector = cls.get_detector()

        features_arr = np.asarray(features, dtype=float)
        result = detector.predict_from_features(features_arr)

        # Backwards-compatible keys: label + score (C)
        return {
            "label_index": result.label_index,
            "label_name": result.label_name,
            "label": result.label_name,
            "score": result.top_score,
            "probabilities": result.probabilities,
        }
