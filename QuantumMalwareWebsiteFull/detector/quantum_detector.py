# detector/quantum_detector.py

from dataclasses import dataclass
from typing import Dict, List

import numpy as np
from sklearn.ensemble import RandomForestClassifier

from .utils import FeatureExtractor


# Multiclass labels (B)
CLASS_LABELS = {
    0: "Safe",
    1: "Malware – Network Attack",
    2: "Malware – File-based Threat",
    3: "Malware – Process Injection",
}


@dataclass
class DetectionResult:
    label_index: int
    label_name: str
    top_score: float
    probabilities: Dict[str, float]


class QuantumMalwareDetector:
    """
    FINAL version:
    - No .pkl loading
    - Trains a RandomForest model in memory at startup
    - Uses FeatureExtractor to turn logs into numeric features
    - Supports multiclass + per-class probabilities
    """

    def __init__(self) -> None:
        self.feature_extractor = FeatureExtractor()
        self.model: RandomForestClassifier | None = None
        self._ensure_trained()

    # ------------------------------------------------------------------
    # Training corpus for hybrid (realistic) log patterns
    # ------------------------------------------------------------------
    def _build_training_corpus(self):
        """
        Build a small hybrid dataset of (log_text, label_index).
        Entire log block = 1 sample (your choice A).
        """

        samples: List[tuple[str, int]] = []

        # ---------------- SAFE ----------------
        samples += [
            (
                "[INFO] 2025-01-15 10:22:13 User login successful: user=admin\n"
                "[INFO] 2025-01-15 10:22:15 File opened: C:\\Windows\\System32\\drivers\\etc\\hosts\n"
                "[INFO] 2025-01-15 10:22:20 HTTP GET request to https://update.microsoft.com\n"
                "[INFO] 2025-01-15 10:22:25 User logoff initiated.\n",
                0,
            ),
            (
                "[INFO] 2025-01-16 09:01:10 System backup completed successfully.\n"
                "[INFO] 2025-01-16 09:10:11 File read: D:\\Backups\\config.zip\n"
                "[INFO] 2025-01-16 09:12:30 Outbound connection to 192.0.2.10:443 (HTTPS)\n",
                0,
            ),
        ]

        # --------- MALWARE – NETWORK ATTACK (1) ---------
        samples += [
            (
                "[WARN] 2025-01-15 03:33:10 Multiple failed access attempts on /var/www/html/admin\n"
                "[WARN] 2025-01-15 03:33:14 Suspicious URL connection: http://198.51.100.25/update\n"
                "[INFO] 2025-01-15 03:33:18 Socket opened to remote host 45.83.23.11:443\n",
                1,
            ),
            (
                "[WARN] 2025-02-01 01:15:00 Brute force login attempts detected from 203.0.113.77\n"
                "[WARN] 2025-02-01 01:15:05 Firewall flagged repeated SSH failures on port 22\n"
                "[INFO] 2025-02-01 01:15:10 Outbound connection to 203.0.113.77:8080\n",
                1,
            ),
        ]

        # --------- MALWARE – FILE-BASED THREAT (2) ---------
        samples += [
            (
                "[WARN] 2025-01-15 02:11:04 Suspicious executable dropped: C:\\temp\\runner.tmp\n"
                "[WARN] 2025-01-15 02:11:06 Unusual file type detected: archive.scr\n"
                "[INFO] 2025-01-15 02:11:08 File modified: C:\\Users\\Admin\\Documents\\secrets.docx\n",
                2,
            ),
            (
                "[WARN] 2025-02-10 12:00:10 File created: C:\\Users\\Public\\svchost.exe\n"
                "[WARN] 2025-02-10 12:00:12 File extension anomaly: report.doc.exe\n"
                "[INFO] 2025-02-10 12:00:20 File modified: C:\\Users\\Admin\\Desktop\\payroll.xlsx\n",
                2,
            ),
        ]

        # --------- MALWARE – PROCESS INJECTION (3) ---------
        samples += [
            (
                "[WARN] 2025-01-18 05:22:30 New process created: powershell.exe PID=2240\n"
                "[WARN] 2025-01-18 05:22:31 Suspicious process tree: powershell.exe -> rundll32.exe\n"
                "[CRITICAL] 2025-01-18 05:22:33 Code injection attempt detected in explorer.exe\n",
                3,
            ),
            (
                "[CRITICAL] 2025-02-20 22:10:00 Suspicious process: inject.exe PID=9010\n"
                "[WARN] 2025-02-20 22:10:02 Remote thread created in lsass.exe\n"
                "[WARN] 2025-02-20 22:10:05 Process hollowing behavior detected.\n",
                3,
            ),
        ]

        X_list: list[np.ndarray] = []
        y_list: list[int] = []

        for log_text, label_idx in samples:
            feats = self.feature_extractor.extract(log_text)
            X_list.append(np.asarray(feats, dtype=float))
            y_list.append(label_idx)

        X = np.vstack(X_list)
        y = np.array(y_list, dtype=int)
        return X, y

    # ------------------------------------------------------------------
    # Training
    # ------------------------------------------------------------------
    def _ensure_trained(self) -> None:
        if self.model is not None:
            return

        X, y = self._build_training_corpus()
        clf = RandomForestClassifier(
            n_estimators=200,
            random_state=42,
            class_weight="balanced"
        )
        clf.fit(X, y)
        self.model = clf

    # ------------------------------------------------------------------
    # Inference using numeric features (C: probabilities)
    # ------------------------------------------------------------------
    def predict_from_features(self, features: np.ndarray) -> DetectionResult:
        """
        features: 1D array of numeric features from FeatureExtractor.
        """
        self._ensure_trained()

        feats = np.asarray(features, dtype=float).reshape(1, -1)
        proba = self.model.predict_proba(feats)[0]

        label_index = int(np.argmax(proba))
        label_name = CLASS_LABELS.get(label_index, "Unknown")

        prob_dict: Dict[str, float] = {
            CLASS_LABELS[i]: float(p) for i, p in enumerate(proba)
        }

        top_score = float(proba[label_index])
        return DetectionResult(
            label_index=label_index,
            label_name=label_name,
            top_score=top_score,
            probabilities=prob_dict,
        )
