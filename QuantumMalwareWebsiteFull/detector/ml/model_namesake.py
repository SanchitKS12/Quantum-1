import numpy as np
import pandas as pd
from sklearn.ensemble import RandomForestClassifier
from sklearn.svm import SVC
from sklearn.decomposition import PCA
from sklearn.preprocessing import StandardScaler
from sklearn.metrics import classification_report, roc_auc_score
from sklearn.model_selection import train_test_split
from sklearn.pipeline import Pipeline
from sklearn.metrics.pairwise import rbf_kernel
import warnings
warnings.filterwarnings("ignore")
use_quantum = False

try:
    import pennylane as qml
    from pennylane import numpy as qnp
    use_quantum = True
except Exception:
    use_quantum = False

def generate_synthetic_behavior_data(n_samples=2000, random_state=42):
    rng = np.random.RandomState(random_state)
    n = n_samples

    file_ops_b = rng.poisson(5, n)
    failed_ratio_b = np.clip(rng.beta(1, 10, n), 0, 1)
    new_procs_b = rng.poisson(1, n)
    net_conn_b = rng.poisson(3, n)
    unusual_ft_b = rng.poisson(0.2, n)
    entropy_change_b = rng.normal(0, 0.1, n)

    file_ops_m = file_ops_b + rng.poisson(20, n)
    failed_ratio_m = np.clip(rng.beta(5, 2, n), 0, 1)
    new_procs_m = new_procs_b + rng.poisson(5, n)
    net_conn_m = net_conn_b + rng.poisson(10, n)
    unusual_ft_m = unusual_ft_b + rng.poisson(5, n)
    entropy_change_m = rng.normal(1.5, 0.5, n)

    is_mal = rng.rand(n) < 0.10
    features = np.vstack([
        np.where(is_mal, file_ops_m, file_ops_b),
        np.where(is_mal, failed_ratio_m, failed_ratio_b),
        np.where(is_mal, new_procs_m, new_procs_b),
        np.where(is_mal, net_conn_m, net_conn_b),
        np.where(is_mal, unusual_ft_m, unusual_ft_b),
        np.where(is_mal, entropy_change_m, entropy_change_b),
    ]).T

    cols = [
        "file_ops_rate",
        "failed_access_ratio",
        "new_procs_created",
        "network_conn_count",
        "unusual_file_types",
        "entropy_change"
    ]
    df = pd.DataFrame(features, columns=cols)
    df["label"] = is_mal.astype(int)
    return df.sample(frac=1, random_state=random_state).reset_index(drop=True)

class Preprocessor:
    def __init__(self, n_components=4):
        self.scaler = StandardScaler()
        self.pca = PCA(n_components=n_components, random_state=0)

    def fit_transform(self, X):
        Xs = self.scaler.fit_transform(X)
        Xp = self.pca.fit_transform(Xs)
        return Xp

    def transform(self, X):
        Xs = self.scaler.transform(X)
        return self.pca.transform(Xs)

class HybridDetector:
    def __init__(self, quantum_weight=0.6):
        self.pre = Preprocessor(n_components=4)
        self.classical = RandomForestClassifier(n_estimators=150, random_state=0)
        self.quantum_svm = None
        self.quantum_provider = QuantumKernelProvider(n_qubits=4)
        self.quantum_weight = quantum_weight
        self.fitted = False
        self._train_xp = None # Store preprocessed training data

    def fit_with_storage(self, X, y):
        Xp = self.pre.fit_transform(X)
        self._train_xp = Xp.copy() # Store preprocessed training X
        self.classical.fit(Xp, y)

        K = self.quantum_provider.compute_kernel_matrix(Xp)
        self.quantum_svm = SVC(kernel='precomputed', probability=True)
        self.quantum_svm.fit(K, y)

        self.fitted = True
        print("Training complete (with stored train embeddings).")

    def predict_proba(self, X_raw):
        if not self.fitted:
            raise RuntimeError("Model not fitted. Call fit_with_storage() first.")
        Xp = self.pre.transform(X_raw)

        p_cl = self.classical.predict_proba(Xp)[:, 1]

        K_test = self.quantum_provider.compute_kernel_matrix(Xp, self._train_xp)
        p_q = self.quantum_svm.predict_proba(K_test)[:, 1]

        fused = self.quantum_weight * p_q + (1 - self.quantum_weight) * p_cl
        return fused, p_cl, p_q

    def predict_stream(self, single_sample_raw, threshold=0.5, mitigation_cb=None, log_cb=None):
        X_raw = np.asarray(single_sample_raw).reshape(1, -1)
        fused, p_cl, p_q = self.predict_proba(X_raw)
        prob = float(fused[0])
        action = "alert" if prob >= threshold else "ok"

        result = {
            "fused_prob": prob,
            "classical_prob": float(p_cl[0]),
            "quantum_prob": float(p_q[0]),
            "action": action
        }

        if action == "alert" and mitigation_cb is not None:
            try:
                mitigation_cb(single_sample_raw, result)
            except Exception as e:
                if log_cb:
                    log_cb({"mitigation_error": str(e), "context": result})
        if log_cb:
            log_cb({ "event": single_sample_raw.tolist(), "result": result })

        return result

def simple_demo():
    print("Generating synthetic dataset...")
    df = generate_synthetic_behavior_data(n_samples=1500)
    X = df.drop(columns=["label"]).values
    y = df["label"].values
    X_train, X_test, y_train, y_test = train_test_split(X, y, stratify=y, test_size=0.3, random_state=0)

    detector = HybridDetector(quantum_weight=0.6)
    detector.fit_with_storage(X_train, y_train)

    fused_probs, _, _ = detector.predict_proba(X_test)
    preds = (fused_probs >= 0.5).astype(int)
    print("\n=== Classification Report (Fused) ===")
    print(classification_report(y_test, preds, digits=4))
    try:
        auc = roc_auc_score(y_test, fused_probs)
        print(f"Fused ROC-AUC: {auc:.4f}")
    except Exception:
        pass

    example = X_test[0]
    def mitigation_cb(sample, context):
        print(f"[MITIGATION] Isolating endpoint; details: prob={context['fused_prob']:.3f}")

    def log_cb(entry):
        print(f"[LOG] {entry}")

    print("\nStreaming example prediction:")
    out = detector.predict_stream(example, threshold=0.5, mitigation_cb=mitigation_cb, log_cb=log_cb)
    print("Stream Result:", out)

if __name__ == "__main__":
    print("Quantum Malware Hunter Prototype starting...")
    if use_quantum:
        print("Pennylane detected: Quantum Kernel will be used (simulator).")
    else:
        print("Pennylane not available: Using classical RBF kernel fallback for 'quantum' component.")
    simple_demo()